name: FOSSA CLI Analysis

on:
  workflow_dispatch:
    inputs:
      release_tags:
        description: 'Comma-separated list of release tags to scan'
        required: true
        default: 'v3.0.0,v2.0.0'

jobs:
  fossa-scan:
    runs-on: ubuntu-latest
    env:
      FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
    steps:
      # Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # Install FOSSA CLI
      - name: Download FOSSA CLI
        run: |
          curl -H 'Cache-Control: no-cache' https://raw.githubusercontent.com/fossas/fossa-cli/master/install-latest.sh | bash
          fossa --version

      # Loop over tags and scan each one
      - name: Scan release tags
        run: |
          # Generate timestamp for this run
          TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
          echo "Revision timestamp: $TIMESTAMP"
          
          IFS=',' read -ra TAGS <<< "${{ github.event.inputs.release_tags }}"
          git fetch --tags
          for TAG in "${TAGS[@]}"; do
            echo "----------------------------"
            echo "Scanning tag: $TAG"
            echo "----------------------------"
            git checkout $TAG
      
            # Run preliminary analyze to check fossa-deps
            OUTPUT=$(fossa analyze --output 2>&1)
            echo "$OUTPUT"
      
            if echo "$OUTPUT" | grep -q '\* fossa-deps file analysis: succeeded'; then
              echo "fossa-deps analysis succeeded, running full FOSSA analyze..."
              fossa analyze --revision "$TIMESTAMP"
              fossa test --revision "$TIMESTAMP"
            else
              echo "fossa-deps analysis failed, skipping full analyze for $TAG"
            fi
      
            echo "Finished scanning $TAG"
            echo ""
          done

